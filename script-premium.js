// ========================================
// ANTIGRAVITY WELFARE CHATBOT - PREMIUM FEATURES
// Advanced Interactive Modules & AI Systems
// ========================================

// Extended Translations Database
const translationsPremium = {
    en: {
        ...translations.en,
        povertyReduction: 'Poverty Reduction',
        savings: 'Savings',
        welfareStars: 'Welfare Stars',
        applications: 'Applications',
        viewPlan: 'View My Plan',
        eligibilityChecker: 'Eligibility Checker',
        instantMatch: 'Instant scheme matcher with AI-powered analysis',
        checkNow: 'Check Now',
        applicationTracker: 'Application Tracker',
        hereForYou: "I'm here for you",
        counseling: 'Counseling',
        motivation: 'Motivation',
        offlineMode: 'Offline Mode',
        arPreview: 'AR Preview',
        encrypted: 'End-to-End Encrypted',
        listening: 'Listening...',
        yourPlan: 'Your Poverty Reduction Plan',
        eligibilityQuiz: 'Eligibility Quiz',
        previous: 'Previous',
        next: 'Next'
    },
    hi: {
        ...translations.hi,
        povertyReduction: '‡§ó‡§∞‡•Ä‡§¨‡•Ä ‡§Æ‡•á‡§Ç ‡§ï‡§Æ‡•Ä',
        savings: '‡§¨‡§ö‡§§',
        welfareStars: '‡§ï‡§≤‡•ç‡§Ø‡§æ‡§£ ‡§∏‡§ø‡§§‡§æ‡§∞‡•á',
        applications: '‡§Ü‡§µ‡•á‡§¶‡§®',
        viewPlan: '‡§Æ‡•á‡§∞‡•Ä ‡§Ø‡•ã‡§ú‡§®‡§æ ‡§¶‡•á‡§ñ‡•á‡§Ç',
        eligibilityChecker: '‡§™‡§æ‡§§‡•ç‡§∞‡§§‡§æ ‡§ú‡§æ‡§Ç‡§ö‡§ï‡§∞‡•ç‡§§‡§æ',
        instantMatch: 'AI-‡§∏‡§Ç‡§ö‡§æ‡§≤‡§ø‡§§ ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§ï‡•á ‡§∏‡§æ‡§• ‡§§‡•ç‡§µ‡§∞‡§ø‡§§ ‡§Ø‡•ã‡§ú‡§®‡§æ ‡§Æ‡§ø‡§≤‡§æ‡§®',
        checkNow: '‡§Ö‡§≠‡•Ä ‡§ú‡§æ‡§Ç‡§ö‡•á‡§Ç',
        applicationTracker: '‡§Ü‡§µ‡•á‡§¶‡§® ‡§ü‡•ç‡§∞‡•à‡§ï‡§∞',
        hereForYou: '‡§Æ‡•à‡§Ç ‡§Ü‡§™‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ø‡§π‡§æ‡§Ç ‡§π‡•Ç‡§Ç',
        counseling: '‡§™‡§∞‡§æ‡§Æ‡§∞‡•ç‡§∂',
        motivation: '‡§™‡•ç‡§∞‡•á‡§∞‡§£‡§æ',
        offlineMode: '‡§ë‡§´‡§º‡§≤‡§æ‡§á‡§® ‡§Æ‡•ã‡§°',
        arPreview: 'AR ‡§™‡•Ç‡§∞‡•ç‡§µ‡§æ‡§µ‡§≤‡•ã‡§ï‡§®',
        encrypted: '‡§è‡§Ç‡§°-‡§ü‡•Ç-‡§è‡§Ç‡§° ‡§è‡§®‡•ç‡§ï‡•ç‡§∞‡§ø‡§™‡•ç‡§ü‡•á‡§°',
        listening: '‡§∏‡•Å‡§® ‡§∞‡§π‡§æ ‡§π‡•Ç‡§Ç...',
        yourPlan: '‡§Ü‡§™‡§ï‡•Ä ‡§ó‡§∞‡•Ä‡§¨‡•Ä ‡§ï‡§Æ ‡§ï‡§∞‡§®‡•á ‡§ï‡•Ä ‡§Ø‡•ã‡§ú‡§®‡§æ',
        eligibilityQuiz: '‡§™‡§æ‡§§‡•ç‡§∞‡§§‡§æ ‡§™‡•ç‡§∞‡§∂‡•ç‡§®‡•ã‡§§‡•ç‡§§‡§∞‡•Ä',
        previous: '‡§™‡§ø‡§õ‡§≤‡§æ',
        next: '‡§Ö‡§ó‡§≤‡§æ'
    },
    te: {
        ...translations.te,
        povertyReduction: '‡∞™‡±á‡∞¶‡∞∞‡∞ø‡∞ï ‡∞§‡∞ó‡±ç‡∞ó‡∞ø‡∞Ç‡∞™‡±Å',
        savings: '‡∞™‡±ä‡∞¶‡±Å‡∞™‡±Å‡∞≤‡±Å',
        welfareStars: '‡∞∏‡∞Ç‡∞ï‡±ç‡∞∑‡±á‡∞Æ ‡∞®‡∞ï‡±ç‡∞∑‡∞§‡±ç‡∞∞‡∞æ‡∞≤‡±Å',
        applications: '‡∞¶‡∞∞‡∞ñ‡∞æ‡∞∏‡±ç‡∞§‡±Å‡∞≤‡±Å',
        viewPlan: '‡∞®‡∞æ ‡∞™‡±ç‡∞≤‡∞æ‡∞®‡±ç ‡∞ö‡±Ç‡∞°‡∞Ç‡∞°‡∞ø',
        eligibilityChecker: '‡∞Ö‡∞∞‡±ç‡∞π‡∞§ ‡∞§‡∞®‡∞ø‡∞ñ‡±Ä‡∞¶‡∞æ‡∞∞‡±Å',
        instantMatch: 'AI-‡∞∂‡∞ï‡±ç‡∞§‡∞ø‡∞§‡±ã ‡∞§‡∞ï‡±ç‡∞∑‡∞£ ‡∞™‡∞•‡∞ï‡∞Ç ‡∞Æ‡±ç‡∞Ø‡∞æ‡∞ö‡∞∞‡±ç',
        checkNow: '‡∞á‡∞™‡±ç‡∞™‡±Å‡∞°‡±Å ‡∞§‡∞®‡∞ø‡∞ñ‡±Ä ‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø',
        applicationTracker: '‡∞¶‡∞∞‡∞ñ‡∞æ‡∞∏‡±ç‡∞§‡±Å ‡∞ü‡±ç‡∞∞‡∞æ‡∞ï‡∞∞‡±ç',
        hereForYou: '‡∞®‡±á‡∞®‡±Å ‡∞Æ‡±Ä ‡∞ï‡±ã‡∞∏‡∞Ç ‡∞á‡∞ï‡±ç‡∞ï‡∞° ‡∞â‡∞®‡±ç‡∞®‡∞æ‡∞®‡±Å',
        counseling: '‡∞ï‡±å‡∞®‡±ç‡∞∏‡±Ü‡∞≤‡∞ø‡∞Ç‡∞ó‡±ç',
        motivation: '‡∞™‡±ç‡∞∞‡±á‡∞∞‡∞£',
        offlineMode: '‡∞Ü‡∞´‡±ç‚Äå‡∞≤‡±à‡∞®‡±ç ‡∞Æ‡±ã‡∞°‡±ç',
        arPreview: 'AR ‡∞™‡±ç‡∞∞‡∞ø‡∞µ‡±ç‡∞Ø‡±Ç',
        encrypted: '‡∞é‡∞Ç‡∞°‡±ç-‡∞ü‡±Å-‡∞é‡∞Ç‡∞°‡±ç ‡∞é‡∞®‡±ç‡∞ï‡±ç‡∞∞‡∞ø‡∞™‡±ç‡∞ü‡±Ü‡∞°‡±ç',
        listening: '‡∞µ‡∞ø‡∞Ç‡∞ü‡±Å‡∞®‡±ç‡∞®‡∞æ‡∞®‡±Å...',
        yourPlan: '‡∞Æ‡±Ä ‡∞™‡±á‡∞¶‡∞∞‡∞ø‡∞ï ‡∞§‡∞ó‡±ç‡∞ó‡∞ø‡∞Ç‡∞™‡±Å ‡∞™‡±ç‡∞≤‡∞æ‡∞®‡±ç',
        eligibilityQuiz: '‡∞Ö‡∞∞‡±ç‡∞π‡∞§ ‡∞ï‡±ç‡∞µ‡∞ø‡∞ú‡±ç',
        previous: '‡∞Æ‡±Å‡∞®‡±Å‡∞™‡∞ü‡∞ø',
        next: '‡∞§‡∞¶‡±Å‡∞™‡∞∞‡∞ø'
    },
    ta: {
        ...translations.ta,
        povertyReduction: '‡Æµ‡Æ±‡ØÅ‡ÆÆ‡Øà ‡Æï‡ØÅ‡Æ±‡Øà‡Æ™‡Øç‡Æ™‡ØÅ',
        savings: '‡Æö‡Øá‡ÆÆ‡Æø‡Æ™‡Øç‡Æ™‡ØÅ',
        welfareStars: '‡Æ®‡Æ≤ ‡Æ®‡Æü‡Øç‡Æö‡Æ§‡Øç‡Æ§‡Æø‡Æ∞‡Æô‡Øç‡Æï‡Æ≥‡Øç',
        applications: '‡Æµ‡Æø‡Æ£‡Øç‡Æ£‡Æ™‡Øç‡Æ™‡Æô‡Øç‡Æï‡Æ≥‡Øç',
        viewPlan: '‡Æé‡Æ©‡Æ§‡ØÅ ‡Æ§‡Æø‡Æü‡Øç‡Æü‡Æ§‡Øç‡Æ§‡Øà‡Æï‡Øç ‡Æï‡Ææ‡Æ£‡Øç‡Æï',
        eligibilityChecker: '‡Æ§‡Æï‡ØÅ‡Æ§‡Æø ‡Æö‡Æ∞‡Æø‡Æ™‡Ææ‡Æ∞‡Øç‡Æ™‡Øç‡Æ™‡Ææ‡Æ≥‡Æ∞‡Øç',
        instantMatch: 'AI-‡Æá‡ÆØ‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡ØÅ‡ÆÆ‡Øç ‡Æâ‡Æü‡Æ©‡Æü‡Æø ‡Æ§‡Æø‡Æü‡Øç‡Æü ‡Æ™‡Øä‡Æ∞‡ØÅ‡Æ§‡Øç‡Æ§‡Æø',
        checkNow: '‡Æá‡Æ™‡Øç‡Æ™‡Øã‡Æ§‡ØÅ ‡Æö‡Æ∞‡Æø‡Æ™‡Ææ‡Æ∞‡Øç‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç',
        applicationTracker: '‡Æµ‡Æø‡Æ£‡Øç‡Æ£‡Æ™‡Øç‡Æ™ ‡Æï‡Æ£‡Øç‡Æï‡Ææ‡Æ£‡Æø‡Æ™‡Øç‡Æ™‡Ææ‡Æ≥‡Æ∞‡Øç',
        hereForYou: '‡Æ®‡Ææ‡Æ©‡Øç ‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡ØÅ‡Æï‡Øç‡Æï‡Ææ‡Æï ‡Æá‡Æô‡Øç‡Æï‡Øá ‡Æá‡Æ∞‡ØÅ‡Æï‡Øç‡Æï‡Æø‡Æ±‡Øá‡Æ©‡Øç',
        counseling: '‡ÆÜ‡Æ≤‡Øã‡Æö‡Æ©‡Øà',
        motivation: '‡Æä‡Æï‡Øç‡Æï‡ÆÆ‡Øç',
        offlineMode: '‡ÆÜ‡ÆÉ‡Æ™‡Øç‡Æ≤‡Øà‡Æ©‡Øç ‡Æ™‡ÆØ‡Æ©‡Øç‡ÆÆ‡ØÅ‡Æ±‡Øà',
        arPreview: 'AR ‡ÆÆ‡ØÅ‡Æ©‡Øç‡Æ©‡Øã‡Æü‡Øç‡Æü‡ÆÆ‡Øç',
        encrypted: '‡Æé‡Æ£‡Øç‡Æü‡Øç-‡Æü‡ØÅ-‡Æé‡Æ£‡Øç‡Æü‡Øç ‡Æé‡Æ©‡Øç‡Æï‡Øç‡Æ∞‡Æø‡Æ™‡Øç‡Æü‡Æü‡Øç',
        listening: '‡Æï‡Øá‡Æü‡Øç‡Æï‡Æø‡Æ±‡Øá‡Æ©‡Øç...',
        yourPlan: '‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æµ‡Æ±‡ØÅ‡ÆÆ‡Øà ‡Æï‡ØÅ‡Æ±‡Øà‡Æ™‡Øç‡Æ™‡ØÅ ‡Æ§‡Æø‡Æü‡Øç‡Æü‡ÆÆ‡Øç',
        eligibilityQuiz: '‡Æ§‡Æï‡ØÅ‡Æ§‡Æø ‡Æµ‡Æø‡Æ©‡Ææ‡Æü‡Æø ‡Æµ‡Æø‡Æ©‡Ææ',
        previous: '‡ÆÆ‡ØÅ‡Æ®‡Øç‡Æ§‡Øà‡ÆØ',
        next: '‡ÆÖ‡Æü‡ØÅ‡Æ§‡Øç‡Æ§‡ØÅ'
    }
};

// Merge premium translations
Object.keys(translationsPremium).forEach(lang => {
    if (translations[lang]) {
        translations[lang] = { ...translations[lang], ...translationsPremium[lang] };
    }
});

// ========================================
// USER STATE & GAMIFICATION
// ========================================

let userState = {
    welfareStars: 0,
    savings: 0,
    applications: 0,
    povertyReductionProgress: 0,
    achievements: [],
    interactions: 0,
    lastInteraction: Date.now()
};

// Load from localStorage
function loadUserState() {
    const saved = localStorage.getItem('welfareUserState');
    if (saved) {
        userState = { ...userState, ...JSON.parse(saved) };
        updateDashboard();
    }
}

function saveUserState() {
    localStorage.setItem('welfareUserState', JSON.stringify(userState));
}

// ========================================
// DASHBOARD MANAGEMENT
// ========================================

function updateDashboard() {
    // Update progress ring
    const progressRing = document.getElementById('povertyProgress');
    const progressValue = document.getElementById('progressValue');
    const circumference = 2 * Math.PI * 52;
    const offset = circumference - (userState.povertyReductionProgress / 100) * circumference;

    if (progressRing) {
        progressRing.style.strokeDashoffset = offset;
    }
    if (progressValue) {
        progressValue.textContent = `${userState.povertyReductionProgress}%`;
    }

    // Update stats
    document.getElementById('savingsValue').textContent = `‚Çπ${userState.savings.toLocaleString()}`;
    document.getElementById('starsValue').textContent = userState.welfareStars;
    document.getElementById('applicationsValue').textContent = userState.applications;
    document.getElementById('starCount').textContent = userState.welfareStars;
}

function initializeDashboard() {
    loadUserState();

    document.getElementById('viewPlanBtn').addEventListener('click', () => {
        showPersonalizedPlan();
        awardStars(5, 'Viewed personalized plan!');
    });
}

// ========================================
// PERSONALIZED PLAN MODAL
// ========================================

function showPersonalizedPlan() {
    const modal = document.getElementById('planModal');

    // Generate job recommendations
    const jobRecs = document.getElementById('jobRecommendations');
    jobRecs.innerHTML = `
        <div class="recommendation-item">
            <strong>üèóÔ∏è Construction Worker</strong>
            <p style="font-size: 12px; opacity: 0.8; margin-top: 4px;">MGNREGA projects nearby ‚Ä¢ ‚Çπ350/day</p>
        </div>
        <div class="recommendation-item">
            <strong>üöó Delivery Partner</strong>
            <p style="font-size: 12px; opacity: 0.8; margin-top: 4px;">Flexible hours ‚Ä¢ ‚Çπ15,000-25,000/month</p>
        </div>
        <div class="recommendation-item">
            <strong>üè™ Retail Assistant</strong>
            <p style="font-size: 12px; opacity: 0.8; margin-top: 4px;">Local stores hiring ‚Ä¢ ‚Çπ12,000/month</p>
        </div>
    `;

    // Generate skill recommendations
    const skillRecs = document.getElementById('skillRecommendations');
    skillRecs.innerHTML = `
        <div class="recommendation-item">
            <strong>üíª Basic Computer Skills</strong>
            <p style="font-size: 12px; opacity: 0.8; margin-top: 4px;">PMKVY certified ‚Ä¢ 3 months ‚Ä¢ Free</p>
        </div>
        <div class="recommendation-item">
            <strong>üîß Electrical Wiring</strong>
            <p style="font-size: 12px; opacity: 0.8; margin-top: 4px;">High demand skill ‚Ä¢ 2 months ‚Ä¢ Free</p>
        </div>
        <div class="recommendation-item">
            <strong>üç≥ Food Preparation</strong>
            <p style="font-size: 12px; opacity: 0.8; margin-top: 4px;">Hospitality sector ‚Ä¢ 1 month ‚Ä¢ Free</p>
        </div>
    `;

    // Savings simulator
    const savingsSim = document.getElementById('savingsSimulator');
    savingsSim.innerHTML = `
        <div style="margin-bottom: 12px;">
            <label style="font-size: 13px; display: block; margin-bottom: 4px;">Monthly Income: ‚Çπ<span id="incomeDisplay">15000</span></label>
            <input type="range" min="5000" max="50000" step="1000" value="15000" id="incomeSlider" style="width: 100%;">
        </div>
        <div style="margin-bottom: 12px;">
            <label style="font-size: 13px; display: block; margin-bottom: 4px;">Save: <span id="savePercent">20</span>%</label>
            <input type="range" min="5" max="50" step="5" value="20" id="saveSlider" style="width: 100%;">
        </div>
        <div style="background: rgba(0, 217, 255, 0.1); padding: 12px; border-radius: 8px; text-align: center;">
            <div style="font-size: 11px; opacity: 0.7; margin-bottom: 4px;">Monthly Savings</div>
            <div style="font-size: 24px; font-weight: 700; color: var(--electric-cyan);" id="savingsResult">‚Çπ3,000</div>
            <div style="font-size: 11px; opacity: 0.7; margin-top: 8px;">In 1 year: <strong id="yearlyResult">‚Çπ36,000</strong></div>
        </div>
    `;

    // Add event listeners for simulator
    setTimeout(() => {
        const incomeSlider = document.getElementById('incomeSlider');
        const saveSlider = document.getElementById('saveSlider');

        function updateSavings() {
            const income = parseInt(incomeSlider.value);
            const savePercent = parseInt(saveSlider.value);
            const monthly = (income * savePercent) / 100;
            const yearly = monthly * 12;

            document.getElementById('incomeDisplay').textContent = income.toLocaleString();
            document.getElementById('savePercent').textContent = savePercent;
            document.getElementById('savingsResult').textContent = `‚Çπ${monthly.toLocaleString()}`;
            document.getElementById('yearlyResult').textContent = `‚Çπ${yearly.toLocaleString()}`;
        }

        incomeSlider.addEventListener('input', updateSavings);
        saveSlider.addEventListener('input', updateSavings);
    }, 100);

    modal.classList.add('active');
}

document.getElementById('planModalClose').addEventListener('click', () => {
    document.getElementById('planModal').classList.remove('active');
});

// ========================================
// ELIGIBILITY CHECKER
// ========================================

const eligibilityQuestions = {
    pmay: [
        {
            question: { en: 'Do you own a pucca (permanent) house?', hi: '‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™‡§ï‡•á ‡§™‡§æ‡§∏ ‡§™‡§ï‡•ç‡§ï‡§æ ‡§ò‡§∞ ‡§π‡•à?', te: '‡∞Æ‡±Ä‡∞ï‡±Å ‡∞™‡∞ï‡±ç‡∞ï‡∞æ ‡∞á‡∞≤‡±ç‡∞≤‡±Å ‡∞â‡∞Ç‡∞¶‡∞æ?', ta: '‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡ØÅ‡Æï‡Øç‡Æï‡ØÅ ‡Æ™‡Æï‡Øç‡Æï‡Ææ ‡Æµ‡ØÄ‡Æü‡ØÅ ‡Æâ‡Æ≥‡Øç‡Æ≥‡Æ§‡Ææ?' },
            options: [
                { en: 'Yes', hi: '‡§π‡§æ‡§Ç', te: '‡∞Ö‡∞µ‡±Å‡∞®‡±Å', ta: '‡ÆÜ‡ÆÆ‡Øç', value: false },
                { en: 'No', hi: '‡§®‡§π‡•Ä‡§Ç', te: '‡∞ï‡∞æ‡∞¶‡±Å', ta: '‡Æá‡Æ≤‡Øç‡Æ≤‡Øà', value: true }
            ]
        },
        {
            question: { en: 'What is your annual household income?', hi: '‡§Ü‡§™‡§ï‡•Ä ‡§µ‡§æ‡§∞‡•ç‡§∑‡§ø‡§ï ‡§ò‡§∞‡•á‡§≤‡•Ç ‡§Ü‡§Ø ‡§ï‡•ç‡§Ø‡§æ ‡§π‡•à?', te: '‡∞Æ‡±Ä ‡∞µ‡∞æ‡∞∞‡±ç‡∞∑‡∞ø‡∞ï ‡∞ï‡±Å‡∞ü‡±Å‡∞Ç‡∞¨ ‡∞Ü‡∞¶‡∞æ‡∞Ø‡∞Ç ‡∞é‡∞Ç‡∞§?', ta: '‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡ÆÜ‡Æ£‡Øç‡Æü‡ØÅ ‡Æï‡ØÅ‡Æü‡ØÅ‡ÆÆ‡Øç‡Æ™ ‡Æµ‡Æ∞‡ØÅ‡ÆÆ‡Ææ‡Æ©‡ÆÆ‡Øç ‡Æé‡Æ©‡Øç‡Æ©?' },
            options: [
                { en: 'Below ‚Çπ3 lakh', hi: '‚Çπ3 ‡§≤‡§æ‡§ñ ‡§∏‡•á ‡§ï‡§Æ', te: '‚Çπ3 ‡∞≤‡∞ï‡±ç‡∞∑‡∞≤ ‡∞ï‡∞Ç‡∞ü‡±á ‡∞§‡∞ï‡±ç‡∞ï‡±Å‡∞µ', ta: '‚Çπ3 ‡Æ≤‡Æü‡Øç‡Æö‡Æ§‡Øç‡Æ§‡Æø‡Æ±‡Øç‡Æï‡ØÅ ‡Æï‡ØÄ‡Æ¥‡Øç', value: true },
                { en: '‚Çπ3-6 lakh', hi: '‚Çπ3-6 ‡§≤‡§æ‡§ñ', te: '‚Çπ3-6 ‡∞≤‡∞ï‡±ç‡∞∑‡∞≤‡±Å', ta: '‚Çπ3-6 ‡Æ≤‡Æü‡Øç‡Æö‡ÆÆ‡Øç', value: true },
                { en: 'Above ‚Çπ6 lakh', hi: '‚Çπ6 ‡§≤‡§æ‡§ñ ‡§∏‡•á ‡§Ö‡§ß‡§ø‡§ï', te: '‚Çπ6 ‡∞≤‡∞ï‡±ç‡∞∑‡∞≤ ‡∞ï‡∞Ç‡∞ü‡±á ‡∞é‡∞ï‡±ç‡∞ï‡±Å‡∞µ', ta: '‚Çπ6 ‡Æ≤‡Æü‡Øç‡Æö‡Æ§‡Øç‡Æ§‡Æø‡Æ±‡Øç‡Æï‡ØÅ ‡ÆÆ‡Øá‡Æ≤‡Øç', value: false }
            ]
        }
    ]
};

let currentQuiz = null;
let currentQuestionIndex = 0;
let quizAnswers = [];

function startEligibilityChecker() {
    currentQuiz = 'pmay';
    currentQuestionIndex = 0;
    quizAnswers = [];

    showQuizQuestion();
    document.getElementById('quizModal').classList.add('active');
    document.getElementById('voiceCommandIndicator').classList.add('active');

    // Simulate voice guidance
    setTimeout(() => {
        document.getElementById('voiceCommandIndicator').classList.remove('active');
    }, 2000);

    awardStars(3, 'Started eligibility check!');
}

function showQuizQuestion() {
    const questions = eligibilityQuestions[currentQuiz];
    if (currentQuestionIndex >= questions.length) {
        showQuizResult();
        return;
    }

    const question = questions[currentQuestionIndex];
    const quizContent = document.getElementById('quizContent');

    quizContent.innerHTML = `
        <div class="quiz-question">${question.question[currentLanguage]}</div>
        <div class="quiz-options">
            ${question.options.map((opt, idx) => `
                <div class="quiz-option" data-value="${opt.value}" data-index="${idx}">
                    ${opt[currentLanguage]}
                </div>
            `).join('')}
        </div>
    `;

    // Add click handlers
    document.querySelectorAll('.quiz-option').forEach(opt => {
        opt.addEventListener('click', function () {
            document.querySelectorAll('.quiz-option').forEach(o => o.classList.remove('selected'));
            this.classList.add('selected');
            quizAnswers[currentQuestionIndex] = this.dataset.value === 'true';
        });
    });

    // Update navigation
    document.getElementById('prevQuizBtn').disabled = currentQuestionIndex === 0;
}

function showQuizResult() {
    const eligible = quizAnswers.every(a => a === true);
    const quizContent = document.getElementById('quizContent');

    quizContent.innerHTML = `
        <div style="text-align: center; padding: 24px;">
            <div style="font-size: 64px; margin-bottom: 16px;">${eligible ? '‚úÖ' : '‚ùå'}</div>
            <h3 style="font-size: 20px; margin-bottom: 12px;">
                ${eligible ? 'You are eligible!' : 'Not eligible at this time'}
            </h3>
            <p style="font-size: 14px; opacity: 0.8; line-height: 1.5;">
                ${eligible
            ? 'Based on your responses, you qualify for PM Awas Yojana. Click below to start your application.'
            : 'You may not qualify for this scheme currently, but we can help you explore other options.'}
            </p>
            ${eligible ? `
                <button class="module-btn primary" style="margin-top: 24px;" onclick="startApplication('pmay')">
                    Start Application
                </button>
            ` : `
                <button class="module-btn" style="margin-top: 24px;" onclick="exploreAlternatives()">
                    Explore Other Schemes
                </button>
            `}
        </div>
    `;

    document.getElementById('nextQuizBtn').textContent = 'Close';
    document.getElementById('nextQuizBtn').onclick = () => {
        document.getElementById('quizModal').classList.remove('active');
    };

    if (eligible) {
        awardStars(10, 'Eligible for PMAY!');
        createCometNotification('üéâ', 'Congratulations! You qualify for PM Awas Yojana');
    }
}

document.getElementById('startCheckerBtn').addEventListener('click', startEligibilityChecker);

document.getElementById('prevQuizBtn').addEventListener('click', () => {
    if (currentQuestionIndex > 0) {
        currentQuestionIndex--;
        showQuizQuestion();
    }
});

document.getElementById('nextQuizBtn').addEventListener('click', () => {
    if (quizAnswers[currentQuestionIndex] !== undefined) {
        currentQuestionIndex++;
        showQuizQuestion();
    }
});

document.getElementById('quizModalClose').addEventListener('click', () => {
    document.getElementById('quizModal').classList.remove('active');
});

// ========================================
// APPLICATION TRACKER
// ========================================

let applications = [
    { id: 1, scheme: 'PMAY', status: 'Under Review', date: '2026-02-05', icon: 'üìù' },
    { id: 2, scheme: 'Ayushman Bharat', status: 'Approved', date: '2026-01-28', icon: '‚úÖ' },
    { id: 3, scheme: 'MGNREGA', status: 'Pending Documents', date: '2026-02-01', icon: '‚è≥' }
];

function updateApplicationTracker() {
    const timeline = document.getElementById('trackerTimeline');

    timeline.innerHTML = applications.map(app => `
        <div class="tracker-item">
            <div class="tracker-icon">${app.icon}</div>
            <div class="tracker-content">
                <div class="tracker-title">${app.scheme}</div>
                <div class="tracker-status">${app.status} ‚Ä¢ ${app.date}</div>
            </div>
        </div>
    `).join('');
}

function startApplication(schemeId) {
    const scheme = schemesDatabase.find(s => s.id === schemeId);
    if (scheme) {
        applications.unshift({
            id: applications.length + 1,
            scheme: scheme.name.en,
            status: 'Submitted',
            date: new Date().toISOString().split('T')[0],
            icon: 'üì§'
        });

        userState.applications++;
        updateApplicationTracker();
        updateDashboard();
        saveUserState();

        createCometNotification('üì§', `Application submitted for ${scheme.name[currentLanguage]}`);
        awardStars(15, 'Submitted an application!');

        document.getElementById('quizModal').classList.remove('active');
    }
}

// ========================================
// EMOTIONAL AI SUPPORT
// ========================================

let emotionalState = 'neutral';
const emotions = {
    happy: { icon: 'üòä', color: '#7fffd4' },
    neutral: { icon: 'üòê', color: '#00d9ff' },
    stressed: { icon: 'üòü', color: '#ff6b9d' },
    motivated: { icon: 'üí™', color: '#ffd700' }
};

function analyzeEmotion(message) {
    const stressWords = ['difficult', 'hard', 'struggle', 'problem', 'worried', '‡§Æ‡•Å‡§∂‡•ç‡§ï‡§ø‡§≤', '‡§ï‡§†‡§ø‡§®', '‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ'];
    const happyWords = ['thank', 'great', 'good', 'happy', '‡§ß‡§®‡•ç‡§Ø‡§µ‡§æ‡§¶', '‡§Ö‡§ö‡•ç‡§õ‡§æ', '‡§ñ‡•Å‡§∂'];

    const lowerMessage = message.toLowerCase();

    if (stressWords.some(word => lowerMessage.includes(word))) {
        emotionalState = 'stressed';
        showEmotionalSupport();
    } else if (happyWords.some(word => lowerMessage.includes(word))) {
        emotionalState = 'happy';
    }

    updateEmotionIndicator();
}

function updateEmotionIndicator() {
    const indicator = document.getElementById('emotionIndicator');
    const icon = indicator.querySelector('.emotion-icon');
    icon.textContent = emotions[emotionalState].icon;
}

function showEmotionalSupport() {
    document.getElementById('supportActions').style.display = 'flex';

    setTimeout(() => {
        document.getElementById('supportActions').style.display = 'none';
    }, 10000);
}

document.getElementById('emotionIndicator').addEventListener('click', () => {
    const actions = document.getElementById('supportActions');
    actions.style.display = actions.style.display === 'none' ? 'flex' : 'none';
});

document.getElementById('counselingBtn').addEventListener('click', () => {
    addBotMessage('I understand this can be challenging. Here are some free counseling resources:\n\nüìû National Helpline: 1800-XXX-XXXX\nüè• Local Mental Health Center\nüí¨ Online Support Groups');
    awardStars(5, 'Accessed counseling resources');
});

document.getElementById('motivationBtn').addEventListener('click', () => {
    const quotes = [
        'Every step forward, no matter how small, is progress. You\'re doing great! üí™',
        'Your determination to improve your situation is inspiring. Keep going! üåü',
        'Remember: This is temporary. Better days are ahead! üåÖ',
        'You\'re not alone in this journey. We\'re here to support you! ü§ù'
    ];
    const quote = quotes[Math.floor(Math.random() * quotes.length)];
    addBotMessage(quote);
    awardStars(3, 'Received motivation');
});

// ========================================
// GAMIFICATION SYSTEM
// ========================================

function awardStars(amount, reason) {
    userState.welfareStars += amount;
    userState.interactions++;
    updateDashboard();
    saveUserState();

    // Show achievement popup
    const popup = document.getElementById('achievementPopup');
    const text = popup.querySelector('.achievement-text');
    text.textContent = `+${amount} ‚≠ê ${reason}`;

    popup.classList.add('show');
    setTimeout(() => {
        popup.classList.remove('show');
    }, 3000);

    // Check for milestones
    checkAchievements();
}

function checkAchievements() {
    if (userState.welfareStars >= 50 && !userState.achievements.includes('star50')) {
        userState.achievements.push('star50');
        createCometNotification('üèÜ', 'Achievement Unlocked: 50 Welfare Stars!');
    }

    if (userState.interactions >= 10 && !userState.achievements.includes('active10')) {
        userState.achievements.push('active10');
        createCometNotification('üéØ', 'Achievement: Active User!');
    }
}

// ========================================
// NOTIFICATION COMETS
// ========================================

function createCometNotification(icon, text) {
    const container = document.getElementById('cometsContainer');
    const comet = document.createElement('div');
    comet.className = 'comet';
    comet.innerHTML = `
        <span class="comet-icon">${icon}</span>
        <span class="comet-text">${text}</span>
    `;

    container.appendChild(comet);

    setTimeout(() => {
        comet.remove();
    }, 3000);

    if (navigator.vibrate) {
        navigator.vibrate([50, 30, 50]);
    }
}

// ========================================
// AR PREVIEW
// ========================================

document.getElementById('arTrigger').addEventListener('click', () => {
    const modal = document.getElementById('arModal');
    const arModel = document.getElementById('arModel');

    arModel.innerHTML = 'üè†';
    arModel.style.fontSize = '64px';

    modal.classList.add('active');
    awardStars(5, 'Viewed AR preview');
});

document.getElementById('arModalClose').addEventListener('click', () => {
    document.getElementById('arModal').classList.remove('active');
});

document.getElementById('rotateBtn').addEventListener('click', () => {
    const model = document.getElementById('arModel');
    model.style.transform = `rotateY(${Math.random() * 360}deg)`;
});

document.getElementById('zoomBtn').addEventListener('click', () => {
    const model = document.getElementById('arModel');
    const currentScale = parseFloat(model.style.transform?.match(/scale\(([^)]+)\)/)?.[1] || 1);
    const newScale = currentScale === 1 ? 1.5 : 1;
    model.style.transform = `scale(${newScale})`;
});

// ========================================
// OFFLINE MODE
// ========================================

function initializeOfflineMode() {
    // Cache schemes data
    localStorage.setItem('cachedSchemes', JSON.stringify(schemesDatabase));

    // Monitor online/offline status
    window.addEventListener('online', () => {
        document.getElementById('offlineIndicator').classList.remove('active');
        syncOfflineData();
    });

    window.addEventListener('offline', () => {
        document.getElementById('offlineIndicator').classList.add('active');
    });
}

function syncOfflineData() {
    // Simulate syncing
    createCometNotification('üîÑ', 'Syncing your data...');
    setTimeout(() => {
        createCometNotification('‚úÖ', 'All data synced successfully!');
    }, 2000);
}

// ========================================
// VOICE COMMANDS
// ========================================

function initializeVoiceCommands() {
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = new SpeechRecognition();

        recognition.continuous = true;
        recognition.interimResults = false;

        // Voice command keywords
        const commands = {
            'check eligibility': startEligibilityChecker,
            'view plan': showPersonalizedPlan,
            'show schemes': () => {
                document.getElementById('schemesCarousel').scrollIntoView({ behavior: 'smooth' });
            }
        };

        recognition.onresult = (event) => {
            const transcript = event.results[event.results.length - 1][0].transcript.toLowerCase();

            for (const [command, action] of Object.entries(commands)) {
                if (transcript.includes(command)) {
                    action();
                    break;
                }
            }
        };
    }
}

// ========================================
// ENHANCED CHAT WITH EMOTION ANALYSIS
// ========================================

const originalSendMessage = sendMessage;
window.sendMessage = function (message) {
    analyzeEmotion(message);
    originalSendMessage(message);
    awardStars(1, 'Sent a message');
};

// ========================================
// INITIALIZATION
// ========================================

document.addEventListener('DOMContentLoaded', () => {
    initializeDashboard();
    updateApplicationTracker();
    initializeOfflineMode();
    initializeVoiceCommands();

    // Simulate progress
    setTimeout(() => {
        userState.povertyReductionProgress = 35;
        userState.savings = 12500;
        updateDashboard();
        saveUserState();
    }, 1000);

    // Welcome achievement
    if (userState.interactions === 0) {
        setTimeout(() => {
            awardStars(10, 'Welcome to Welfare Support!');
        }, 2000);
    }
});

// Export functions for global access
window.startApplication = startApplication;
window.exploreAlternatives = function () {
    document.getElementById('quizModal').classList.remove('active');
    document.getElementById('schemesCarousel').scrollIntoView({ behavior: 'smooth' });
    addBotMessage('Let me show you other schemes you might be eligible for. Check out the carousel above!');
};
